# Production Deployment

This directory contains production deployment configuration for TimeTiles.

## Documentation

For complete deployment instructions, see the **[Admin Guide â†’ Deployment](https://docs.timetiles.io/admin-guide/deployment)** documentation.

## Quick Start

```bash
# From deployment directory
./deploy.sh setup    # Create .env.production
./deploy.sh pull     # Pull Docker images from registry
./deploy.sh up       # Start services
./deploy.sh ssl      # Setup Let's Encrypt SSL certificates
./deploy.sh check    # Verify deployment health
```

## Configuration Files

| File | Purpose |
|------|---------|
| `.env.production.example` | Environment template - copy to `.env.production` |
| `docker-compose.prod.yml` | Main service orchestration (PostgreSQL, app, nginx) |
| `docker-compose.override.yml.example` | Optional local build override |
| `nginx/nginx.conf` | Main nginx configuration |
| `nginx/sites-enabled/app.conf` | Site config with SSL and proxy rules |
| `nginx/proxy-headers.conf` | Shared proxy headers (DRY) |

## Deploy Script Commands

```bash
./deploy.sh setup    # Initial setup (copy env, generate secrets)
./deploy.sh pull     # Pull images from registry
./deploy.sh build    # Build locally (if override exists) or pull
./deploy.sh up       # Start all services
./deploy.sh down     # Stop all services
./deploy.sh restart  # Restart all services
./deploy.sh logs     # View logs (follow mode)
./deploy.sh status   # Check service health
./deploy.sh check    # Comprehensive deployment verification
./deploy.sh ssl      # Initialize Let's Encrypt certificate
./deploy.sh update   # Pull latest code/images and redeploy
./deploy.sh backup   # Backup management (full|db|uploads|auto|list|prune|verify|clean)
./deploy.sh restore  # Restore from backup
```

## Bootstrap (Fresh Server)

For fresh Ubuntu 24.04 servers, use the bootstrap script:

```bash
curl -fsSL https://raw.githubusercontent.com/jfilter/timetiles/main/deployment/bootstrap/install.sh | sudo bash
```

See `bootstrap/` for server provisioning scripts.

## Troubleshooting

### PostgreSQL Connection Issues

The kartoza/postgis image requires TCP connections. If you see "peer authentication failed":

```bash
# Correct: Use -h localhost to force TCP
pg_isready -h localhost -U timetiles_user -d timetiles

# Backup commands also use -h localhost internally
./deploy.sh backup db
```

### SSL Certificate Issues

Self-signed certificates are generated automatically as a fallback. To get Let's Encrypt:

1. Ensure DNS points to your server: `dig your-domain.com`
2. Run: `./deploy.sh ssl`
3. Check certificate: `./deploy.sh check` (SSL section)

### Container Health

```bash
./deploy.sh status   # Quick health check
./deploy.sh check    # Full verification including security settings
./deploy.sh logs     # View all logs
```

## Environment Variables

Key variables in `.env.production`:

| Variable | Description |
|----------|-------------|
| `DB_USER` | PostgreSQL username (default: `timetiles_user`) |
| `DB_PASSWORD` | PostgreSQL password (required) |
| `DB_NAME` | Database name (default: `timetiles`) |
| `PAYLOAD_SECRET` | CMS encryption key (auto-generated by setup) |
| `DOMAIN_NAME` | Your domain (e.g., `timetiles.example.com`) |
| `LETSENCRYPT_EMAIL` | Email for SSL certificate notifications |

## All-in-One Image

For demos or small deployments, an all-in-one image is available:

```bash
docker run -d -p 80:80 -p 443:443 \
  -e PAYLOAD_SECRET=your-secret \
  -v timetiles-data:/data \
  ghcr.io/jfilter/timetiles:latest-allinone
```

See `allinone/` for the Dockerfile and configuration.
