# Production Deployment

This guide covers deploying TimeTiles to production using Docker and Docker Compose.

## Overview

TimeTiles provides a production-ready Docker deployment with:

- **Nginx** reverse proxy with SSL/TLS termination
- **Next.js** application server (standalone build)
- **PostgreSQL 17** with PostGIS 3.5+
- **Certbot** for automatic SSL certificate renewal

## Quick Start

### Option 1: Docker Compose (Recommended)

```bash
# 1. Clone deployment files
git clone --depth 1 --filter=blob:none --sparse https://github.com/jfilter/timetiles.git
cd timetiles
git sparse-checkout set deployment

# 2. Configure environment
cp deployment/.env.production.example deployment/.env.production
nano deployment/.env.production
# Set: DOMAIN_NAME, DB_PASSWORD, PAYLOAD_SECRET, LETSENCRYPT_EMAIL

# 3. Pull and start
./deploy.sh pull
./deploy.sh up

# 4. Initialize SSL (after DNS is configured)
./deploy.sh ssl
```

### Option 2: All-in-One Container

For demos, small teams, or quick trials:

```bash
docker run -d \
  -p 80:80 -p 443:443 \
  -v timetiles-data:/data \
  -e PAYLOAD_SECRET=$(openssl rand -base64 32) \
  -e DB_PASSWORD=$(openssl rand -base64 16) \
  ghcr.io/jfilter/timetiles:latest-allinone
```

### Option 3: Automated Server Setup (Ubuntu 24.04)

```bash
curl -sSL https://raw.githubusercontent.com/jfilter/timetiles/main/deployment/bootstrap/install.sh | sudo bash
```

## Deployment Options

| Option | Best For | Scaling | Maintenance |
|--------|----------|---------|-------------|
| **Docker Compose** | Production, teams | Horizontal (multiple instances) | Standard Docker ops |
| **All-in-One** | Demos, small teams, personal | Single server only | Simple, self-contained |
| **Bootstrap Script** | Fresh Ubuntu servers | Same as Compose | Includes security hardening |

### Docker Compose Architecture

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Nginx     │────▶│   Next.js   │────▶│  PostgreSQL │
│  (SSL/TLS)  │     │    App      │     │  + PostGIS  │
└─────────────┘     └─────────────┘     └─────────────┘
```

### All-in-One Architecture

```
┌─────────────────────────────────────────┐
│           Single Container              │
│  ┌───────┐  ┌────────┐  ┌───────────┐  │
│  │ Nginx │──│Next.js │──│ PostgreSQL│  │
│  └───────┘  └────────┘  └───────────┘  │
│         (supervisord manages all)       │
└─────────────────────────────────────────┘
```

## Prerequisites

See [Installation Guide](/admin-guide/installation) for complete system requirements and prerequisites.

## File Structure

```
deployment/
├── Dockerfile.prod              # Multi-stage production build
├── docker-compose.prod.yml      # Service orchestration
├── deploy.sh                    # Deployment helper script
├── .env.production.example      # Environment template
├── .env.production             # Your configuration (create from .example)
└── nginx/                       # Nginx configuration
    ├── nginx.conf              # Main configuration
    └── sites-enabled/          # Site-specific configs
```

## Configuration

Create your environment file:

```bash
cp deployment/.env.production.example deployment/.env.production
nano deployment/.env.production
```

See [Configuration Guide](/admin-guide/configuration) for all environment variables. At minimum, configure:

- `DOMAIN_NAME` - Your production domain
- `DB_PASSWORD` - Strong database password
- `PAYLOAD_SECRET` - Random 32+ character secret (generate with: `openssl rand -base64 32`)
- `LETSENCRYPT_EMAIL` - Email for SSL certificate notifications

## SSL/TLS Setup

### Let's Encrypt (Recommended)

Automatic SSL certificates:

```bash
# After DNS is configured and services are running
./deploy.sh ssl
```

Certificates auto-renew every 12 hours via Certbot.

### Custom Certificates

1. Place certificates in `deployment/nginx/ssl/`:
   - `fullchain.pem` (certificate + chain)
   - `privkey.pem` (private key)
2. Update nginx config to reference your certificates
3. Restart: `docker-compose -f deployment/docker-compose.prod.yml restart nginx`

## Deployment Commands

### Using deploy.sh Script

```bash
# Service Management
./deploy.sh up        # Start all services
./deploy.sh down      # Stop all services
./deploy.sh restart   # Restart services
./deploy.sh status    # Check service health

# Maintenance
./deploy.sh logs      # View logs
./deploy.sh update    # Pull updates and redeploy

# Note: Database migrations run automatically on container startup
```

### Direct Docker Compose

For advanced usage:

```bash
# Define alias for convenience
alias dc-prod="docker-compose -f deployment/docker-compose.prod.yml --env-file deployment/.env.production"

# Examples
dc-prod ps            # List containers
dc-prod logs web      # View web logs
dc-prod exec web sh   # Shell into web container
```

## Security

### Network Security

- Only ports 80 (HTTP) and 443 (HTTPS) are exposed
- Internal services communicate on private Docker network
- PostgreSQL is not exposed externally

### Application Security

- Next.js runs as non-root user
- Environment secrets isolated
- HTTPS enforced with security headers
- Rate limiting on API endpoints

### Security Checklist

- [x] Strong database password (20+ characters)
- [x] Random Payload secret (32+ characters)
- [x] HTTPS enabled with valid certificate
- [x] Firewall configured (allow only 80, 443, SSH)
- [x] Regular security updates enabled
- [x] Backup strategy in place

## Health Checks

Verify deployment:

```bash
# Check all services
./deploy.sh status

# Check application health
curl https://your-domain.com/api/health

# Should return: {"status":"ok","timestamp":"..."}
```

## Common Issues

### Build Fails with Out of Memory

Add swap space:

```bash
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

Or build locally and push image to registry.

### SSL Certificate Fails

Verify DNS and Let's Encrypt challenge:

```bash
# Check DNS resolves to your server
nslookup your-domain.com

# Test HTTP challenge path
curl http://your-domain.com/.well-known/acme-challenge/test
```

For more troubleshooting, see [Maintenance Guide](/admin-guide/maintenance#troubleshooting).

## Next Steps

After successful deployment:

1. **Set up monitoring**: See [Monitoring Guide](/admin-guide/maintenance#monitoring)
2. **Configure backups**: See [Backup Guide](/admin-guide/maintenance#backups)
3. **Performance tuning**: See [Maintenance Guide](/admin-guide/maintenance#performance)
4. **Review security**: See [Configuration Guide](/admin-guide/configuration#security)

## Updating Production

### With Pre-built Images (Default)

```bash
# Edit version in .env.production
# TIMETILES_VERSION=v1.2.0

# Pull new images and restart
./deploy.sh update
```

### With Local Builds

If using `docker-compose.override.yml` for local builds:

```bash
git pull
./deploy.sh build
./deploy.sh up
```

See [Maintenance Guide](/admin-guide/maintenance) for routine operations.
