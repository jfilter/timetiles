# Testing Guidelines

Testing strategy for TimeTiles: unit tests for logic, integration tests for workflows, E2E tests for user journeys.

## Core Principle

**Use real implementations.** Only mock external paid APIs, rate-limited services, or when testing error scenarios.

## Test Types

### Unit Tests (`tests/unit/`)

Test isolated functions and business logic.

- **Framework:** Vitest
- **Speed:** < 100ms per test
- **Setup:** Mock payload objects, use test data factories
- **Examples:** Coordinate parsing, date formatting, schema validation

### Integration Tests (`tests/integration/`)

Test components working together with real database.

- **Framework:** Vitest with PostgreSQL
- **Setup:** `createIntegrationTestEnvironment()`
- **Database:** Isolated per worker, auto cleanup
- **Examples:** File uploads, job processing, API endpoints

### E2E Tests (`tests/e2e/`)

Test complete user workflows in the browser.

- **Framework:** Playwright
- **Environment:** Full application stack
- **Examples:** Import workflow, map exploration, data filtering

## Mocking Rules

### Never Mock

- Database operations → use test database
- Payload CMS operations → use real Payload
- Internal services → use actual implementations
- File system → use temp directories
- Job queues → use real handlers

### Can Mock (Document Why)

- **External paid APIs** (Google Maps) → costs and rate limits
- **Rate-limited services** → avoid CI/CD quotas
- **Network failures** → test error handling
- **Time** → `vi.setSystemTime()` for date tests

### Example: Mocking External API

```typescript
/**
 * Mocking acceptable because:
 * - Testing OUR caching/fallback logic
 * - Real API has costs and rate limits
 * - Need deterministic test scenarios
 */
vi.mock("node-geocoder", () => ({ default: mockGeocoder }));
```

## Running Tests

**From project root** (monorepo orchestration):

```bash
make test         # Run all tests across all packages
make test-ai      # AI-friendly output (silent, JSON results)
```

**From `apps/web`** (package-specific commands):

```bash
# Unit and Integration
pnpm test                    # All tests
pnpm test:debug              # Verbose output with logs
pnpm test:unit               # Unit tests only
pnpm test:integration        # Integration tests only
pnpm test:coverage           # With coverage report

# E2E Tests
pnpm test:e2e                # All E2E tests
pnpm test:e2e:debug          # Debug mode (headed, visible)

# Specific tests
pnpm test tests/unit/services/schema-builder.test.ts
pnpm test --grep "geocoding"

# With debugging logs
LOG_LEVEL=debug pnpm test tests/integration/services/seed-config.test.ts
```

**AI Output:** Results saved to `.test-results.json`, `.lint-results.json`, `.typecheck-results.json`

## Test Setup Patterns

### Integration Tests (with Database)

Use `createIntegrationTestEnvironment()` for tests that need real PostgreSQL and Payload CMS:

```typescript
import { createIntegrationTestEnvironment, withCatalog, withDataset } from "@/tests/setup/integration-test-environment";

let testEnv: Awaited<ReturnType<typeof createIntegrationTestEnvironment>>;

beforeAll(async () => {
  testEnv = await createIntegrationTestEnvironment();
});
afterAll(async () => {
  await testEnv.cleanup();
});
beforeEach(async () => {
  await testEnv.seedManager.truncate();
});

it("processes import file", async () => {
  const { catalog } = await withCatalog(testEnv);
  const { dataset } = await withDataset(testEnv, catalog.id);
  // Test with real database and Payload...
});
```

**Use for:** File uploads, job processing, API endpoints, access control, geospatial queries

### Unit Tests (with Mocks)

Use factories and mocks for tests that verify business logic:

```typescript
import { vi } from "vitest";
import { createEvent } from "@/tests/setup/factories";

const mockPayload = { findByID: vi.fn(), create: vi.fn() };

it("validates event data", () => {
  const event = createEvent({ data: { title: "Test" } });
  expect(validateEvent(event).valid).toBe(true);
});
```

**Use for:** Validation logic, coordinate parsing, schema building, date formatting, utility functions

### Component Tests (with Factories)

```typescript
import { renderWithProviders } from "@/tests/setup/test-utils";
import { createEvent } from "@/tests/setup/factories";

const event = createEvent({ data: { title: "My Event" } });
const { getByText } = renderWithProviders(<EventCard event={event} />);
expect(getByText("My Event")).toBeInTheDocument();
```
