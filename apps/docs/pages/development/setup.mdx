# Development Setup

This project uses Docker Compose for the development environment with PostgreSQL 17 + PostGIS.

## Quick Start

1. **Setup environment**:

   ```bash
   make setup
   ```

2. **Start development (infrastructure + server)**:

   ```bash
   make dev
   ```

That's it! The `make dev` command will:

- Check if infrastructure is running
- Start Docker services if needed
- Launch the Next.js development server

## Alternative Workflows

If you prefer to manage services separately:

```bash
# Start only infrastructure
make up

# Start only the development server
pnpm dev

# Or force-restart infrastructure first
make dev-full
```

## Services

### PostgreSQL with PostGIS

- **Host**: localhost:5432
- **Database**: timetiles
- **Username**: timetiles_user
- **Password**: timetiles_password
- **Extensions**: PostGIS, PostGIS Topology

## Available Commands

### üöÄ Development

```bash
make setup      # Install dependencies and create .env file
make dev        # Start development server (auto-starts infrastructure)
make dev-full   # Start infrastructure and development server
make build      # Build the project
```

### üîç Code Quality

```bash
make lint       # Run ESLint
make format     # Format code with Prettier
make test       # Run tests
```

### üê≥ Infrastructure

```bash
make up         # Start development environment
make down       # Stop development environment
make logs       # View container logs
make db-reset   # Reset database (removes all data)
make db-shell   # Open PostgreSQL shell
make clean      # Clean up everything
```

## Database Schema

The project uses Payload CMS with PostgreSQL + PostGIS for spatial data management:

- PostGIS geometry support for spatial data
- JSONB fields for flexible data storage
- Payload CMS collections for structured content management
- GraphQL and REST APIs automatically generated

## Environment Variables

Copy `.env.example` to `.env.local` and adjust as needed:

```bash
cp apps/web/.env.example apps/web/.env.local
```

### Core Variables

- `DATABASE_URL`: PostgreSQL connection string
- `PAYLOAD_SECRET`: Secret key for Payload CMS
- `NEXT_PUBLIC_PAYLOAD_URL`: Public URL for the application

### Import System Variables

For the Event Data Import System, additional variables are available:

```bash
# Geocoding Services (optional but recommended)
GOOGLE_MAPS_API_KEY=your_google_maps_api_key_here

# File Upload Configuration
MAX_FILE_SIZE_AUTHENTICATED=104857600   # 100MB for authenticated users
MAX_FILE_SIZE_UNAUTHENTICATED=10485760  # 10MB for unauthenticated users

# Rate Limiting (for unauthenticated users)
RATE_LIMIT_FILE_UPLOAD=5               # 5 uploads per hour
RATE_LIMIT_PROGRESS_CHECK=100           # 100 progress checks per hour
RATE_LIMIT_WINDOW_MS=3600000            # 1 hour window

# Job Processing Configuration
BATCH_SIZE=100                          # Rows processed per batch
GEOCODING_BATCH_SIZE=10                 # Addresses geocoded per batch
GEOCODING_DELAY_MS=1000                 # Delay between geocoding batches

# Cache Configuration
GEOCODING_CACHE_CLEANUP_DAYS=90         # Cache cleanup threshold
GEOCODING_CACHE_MIN_HITS=3              # Minimum hits to keep cache entry
```

### Google Maps API Setup

For full geocoding functionality in the import system:

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing one
3. Enable the **Geocoding API**
4. Create credentials (API Key)
5. Restrict the API key to Geocoding API for security
6. Add the key to your `.env.local` file

**Note**: The system will fall back to OpenStreetMap Nominatim if Google Maps API is not configured.

## Troubleshooting

### ARM64/Apple Silicon Compatibility

The Docker Compose setup uses `platform: linux/amd64` for PostgreSQL to ensure PostGIS compatibility across all platforms.

### Reset everything

```bash
make clean
make setup
make up
```

### View logs

```bash
make logs
```

### Check service health

```bash
docker compose -f docker-compose.dev.yml ps
```
