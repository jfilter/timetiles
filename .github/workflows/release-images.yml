name: Release Docker Images

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-main:
    name: Build Main Image
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push main image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployment/Dockerfile.prod
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-allinone:
    name: Build All-in-One Image
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            suffix=-allinone,onlatest=true
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push all-in-one image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deployment/Dockerfile.allinone
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [build-main, build-allinone]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix for semver tag
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using version: $VERSION"

      - name: Pull main image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}

      - name: Start PostgreSQL container
        run: |
          docker network create timetiles-test

          docker run -d \
            --name postgres \
            --network timetiles-test \
            -e POSTGRES_USER=timetiles_user \
            -e POSTGRES_PASSWORD=test_password \
            -e POSTGRES_DB=timetiles \
            postgis/postgis:17-3.5-alpine

          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec postgres pg_isready -U timetiles_user -d timetiles; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Start application container
        run: |
          docker run -d \
            --name timetiles \
            --network timetiles-test \
            -p 3000:3000 \
            -e DATABASE_URL=postgresql://timetiles_user:test_password@postgres:5432/timetiles \
            -e PAYLOAD_SECRET=test_secret_for_smoke_test_only \
            -e NEXT_PUBLIC_PAYLOAD_URL=http://localhost:3000 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}

          # Wait for application to start
          echo "Waiting for application to start..."
          sleep 10

      - name: Check health endpoint
        run: |
          echo "Checking health endpoint..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if curl -f --max-time 5 http://localhost:3000/api/health 2>/dev/null; then
              echo ""
              echo "Health check passed!"
              exit 0
            fi
            echo "Waiting for application... (attempt $((attempt+1))/$max_attempts)"
            sleep 2
            attempt=$((attempt+1))
          done

          echo "Health check failed after $max_attempts attempts"
          echo "Application logs:"
          docker logs timetiles
          exit 1

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Application Logs ==="
          docker logs timetiles 2>&1 || true

          echo ""
          echo "=== PostgreSQL Logs ==="
          docker logs postgres 2>&1 || true

      - name: Cleanup
        if: always()
        run: |
          docker stop timetiles postgres 2>/dev/null || true
          docker rm timetiles postgres 2>/dev/null || true
          docker network rm timetiles-test 2>/dev/null || true
