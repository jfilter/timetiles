name: Test Production Deployment

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'

jobs:
  test-production-deployment:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install bats
        run: sudo apt-get update && sudo apt-get install -y bats

      - name: Make scripts executable
        run: |
          chmod +x timetiles deployment/timetiles
          chmod +x deployment/tests/*.sh
          chmod +x deployment/tests/helpers/*.sh

      - name: Run deployment tests
        run: |
          cd deployment/tests
          ./run-all.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          cd deployment
          if [[ -f docker-compose.test.yml ]]; then
            docker compose -f docker-compose.prod.yml -f docker-compose.test.yml --env-file .env.production logs --tail=200 || true
          else
            docker compose -f docker-compose.prod.yml --env-file .env.production logs --tail=200 || true
          fi

      - name: Cleanup
        if: always()
        run: |
          ./timetiles down || true
          docker system prune -f || true
